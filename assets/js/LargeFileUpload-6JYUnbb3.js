import{u as k,p as C,q as y}from"./vendor-element-BEVhuBaa.js";import{n as L,r as i,c as x,o as N,S as p,Q as r,X as P,Y as U,y as c,U as b,ae as z,q as B,b5 as f}from"./vendor-1TA-WTiO.js";const D={class:"large-file-upload"},V=L({__name:"LargeFileUpload",setup(S){const u=i([]),t=i([]),d=i(""),m=x(()=>{var a;if(!((a=t.value[0])!=null&&a.size))return 0;const s=u.value.reduce((l,e)=>l+e.progressLoaded,0);return Math.floor(s/t.value[0].size*100)});function h(s,a=1024*1024*10){const l=[];let e=0;for(;e<s.size;)l.push({file:s.slice(e,e+a),progressLoaded:0}),e=e+a;return l}function v(){return new Promise(s=>{const a=new Worker("/js/hash.js"),l={fileChunks:u.value.map(e=>e.file)};a.postMessage(l),a.onmessage=e=>{const{hash:o}=e.data;o&&(s(o),a.terminate())}})}const n=i(!1);async function _(){n.value=!0,d.value=await v();const s=u.value.map((a,l)=>{const e=new FormData;return e.append("fileName",t.value[0].name),e.append("file",a.file),e.append("hash",`${d.value}-${l}`),f({url:"/api/upload/uploadChunk",method:"POST",data:e,onUploadProgress:o=>{o!=null&&o.total&&(a.progressLoaded=o.loaded)}})});await Promise.all(s).catch(a=>{y.error("上传失败"),n.value=!1,t.value=[]}),await g().catch(a=>{n.value=!1,t.value=[]}),n.value=!1}async function g(){var a;const s=await f.post("/api/upload/merge",{fileName:t.value[0].name,hash:d.value});s.status===200&&(t.value[0].url=((a=s.data)==null?void 0:a.url)||"")}async function w(s){t.value=[{name:s.name,size:s.size}],u.value=h(s.raw),await _()}return(s,a)=>{const l=C,e=k;return B(),N("div",D,[p(e,{"file-list":t.value,"onUpdate:fileList":a[0]||(a[0]=o=>t.value=o),action:"#","auto-upload":!1,"on-change":w},{trigger:r(()=>[p(l,{type:"primary",disabled:n.value},{default:r(()=>a[1]||(a[1]=[z("选择文件",-1)])),_:1,__:[1]},8,["disabled"])]),tip:r(()=>a[2]||(a[2]=[c("div",{class:"el-upload__tip"},"文件大小不能超过2G",-1)])),default:r(()=>[P(c("span",{class:"upload-progress"},"上传中"+b(m.value)+"%...",513),[[U,n.value]])]),_:1},8,["file-list"])])}}});export{V as default};
