import{u as C,p as y,q as x}from"./vendor-element-BEVhuBaa.js";import{n as L,r as d,c as P,o as N,S as m,Q as p,X as U,Y as b,y as v,U as z,ae as B,q as D,b5 as g}from"./vendor-1TA-WTiO.js";async function S(h,u=5){const t=[],l=[];for(const c of h){const i=c().then(f=>(l.splice(l.indexOf(i),1),f));t.push(i),l.push(i),l.length>=u&&await Promise.race(l)}return Promise.all(t)}const q={class:"large-file-upload"},V=L({__name:"LargeFileUpload",setup(h){const u=d([]),t=d([]),l=d(""),c=P(()=>{var e;if(!((e=t.value[0])!=null&&e.size))return 0;const s=u.value.reduce((o,a)=>o+a.progressLoaded,0);return Math.floor(s/t.value[0].size*100)});function i(s,e=1024*1024*10){const o=[];let a=0;for(;a<s.size;)o.push({file:s.slice(a,a+e),progressLoaded:0}),a=a+e;return o}function f(){return new Promise(s=>{const e=new Worker("/js/hash.js"),o={fileChunks:u.value.map(a=>a.file)};e.postMessage(o),e.onmessage=a=>{const{hash:n}=a.data;n&&(s(n),e.terminate())}})}const r=d(!1);async function _(){r.value=!0,l.value=await f();const s=u.value.map((e,o)=>{const a=new FormData;return a.append("fileName",t.value[0].name),a.append("file",e.file),a.append("hash",`${l.value}-${o}`),()=>g({url:"/api/upload/uploadChunk",method:"POST",headers:{"Content-Type":"multipart/form-data"},data:a,onUploadProgress:n=>{n!=null&&n.total&&(e.progressLoaded=n.loaded)}})});await S(s,5).catch(e=>{x.error("上传失败"),r.value=!1,t.value=[]}),await w().catch(e=>{r.value=!1,t.value=[]}),r.value=!1}async function w(){var e;const s=await g.post("/api/upload/merge",{fileName:t.value[0].name,hash:l.value});s.status===200&&(t.value[0].url=((e=s.data)==null?void 0:e.url)||"")}async function k(s){t.value=[{name:s.name,size:s.size}],u.value=i(s.raw),await _()}return(s,e)=>{const o=y,a=C;return D(),N("div",q,[m(a,{"file-list":t.value,"onUpdate:fileList":e[0]||(e[0]=n=>t.value=n),action:"#","auto-upload":!1,"on-change":k},{trigger:p(()=>[m(o,{type:"primary",disabled:r.value},{default:p(()=>e[1]||(e[1]=[B("选择文件",-1)])),_:1,__:[1]},8,["disabled"])]),tip:p(()=>e[2]||(e[2]=[v("div",{class:"el-upload__tip"},"文件大小不能超过2G",-1)])),default:p(()=>[U(v("span",{class:"upload-progress"},"上传中"+z(c.value)+"%...",513),[[b,r.value]])]),_:1},8,["file-list"])])}}});export{V as default};
