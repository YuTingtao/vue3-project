var U=Object.defineProperty,b=Object.defineProperties;var z=Object.getOwnPropertyDescriptors;var w=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var x=(l,t,a)=>t in l?U(l,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):l[t]=a,L=(l,t)=>{for(var a in t||(t={}))B.call(t,a)&&x(l,a,t[a]);if(w)for(var a of w(t))F.call(t,a)&&x(l,a,t[a]);return l},y=(l,t)=>b(l,z(t));var g=(l,t,a)=>new Promise((k,m)=>{var _=i=>{try{c(a.next(i))}catch(p){m(p)}},v=i=>{try{c(a.throw(i))}catch(p){m(p)}},c=i=>i.done?k(i.value):Promise.resolve(i.value).then(_,v);c((a=a.apply(l,t)).next())});import{v as R,p as T,q as E}from"./vendor-element-BmLiLk8B.js";import{q as V,r as $,$ as j,bb as A,t as D,_ as P,R as C,z as M,af as S,v as G,ba as q}from"./vendor-DhfBk_Fo.js";const H={class:"large-file-upload"},J=V({__name:"LargeFileUpload",setup(l){const t=$([]),a=j({}),k=A(5);function m(s,e=1024*1024*10){const n=[];let o=0;for(;o<s.size;)n.push({file:s.slice(o,o+e),progressLoaded:0}),o=o+e;return n}function _(s){return new Promise(e=>{const n=new Worker("/js/hash.js"),o={fileChunks:a[s].chunks.map(u=>u.file)};n.postMessage(o),n.onmessage=u=>{const{hash:r}=u.data;r&&(e(r),n.terminate())}})}function v(s){var r;const e=t.value.findIndex(h=>h.uid===s),n=a[s].chunks.reduce((h,d)=>h+d.progressLoaded,0);if(!((r=t.value[e])!=null&&r.size))return 100;const o=t.value[e].size,u=n/o*100;return u>100?100:u}function c(s){return g(this,null,function*(){var n;const e=yield q.post("/api/upload/merge",{fileName:t.value[0].name,hash:a[s].hash});e.status===200&&(t.value[0].url=((n=e.data)==null?void 0:n.url)||"")})}function i(s){return g(this,null,function*(){const e=s.file.uid,n=a[e].hash,o=a[e].chunks.map((r,h)=>{const d=new FormData;return d.append("fileName",t.value[0].name),d.append("file",r.file),d.append("hash",`${n}-${h}`),k(()=>q({url:"/api/upload/uploadChunk",method:"POST",headers:{"Content-Type":"multipart/form-data"},data:d,onUploadProgress:f=>{f!=null&&f.total&&(r.progressLoaded=f.loaded);const N=y(L({},f),{percent:v(e)});s.onProgress(N)}}))});(yield Promise.all(o).catch(r=>{s.onError(r),delete a[e],E.error("上传失败")}))&&(yield c(e).then(r=>{s.onSuccess(r)}).catch(r=>{s.onError(r),delete a[e],E.error("上传失败")}))})}function p(s){return g(this,null,function*(){const{file:e}=s;a[e.uid]={chunks:[],hash:""},a[e.uid].chunks=m(e),a[e.uid].hash=yield _(e.uid),i(s)})}return(s,e)=>{const n=T,o=R;return G(),D("div",H,[P(o,{"file-list":t.value,"onUpdate:fileList":e[0]||(e[0]=u=>t.value=u),action:"#",multiple:!0,"http-request":p},{trigger:C(()=>[P(n,{type:"primary"},{default:C(()=>[...e[1]||(e[1]=[S("选择文件",-1)])]),_:1})]),tip:C(()=>[...e[2]||(e[2]=[M("div",{class:"el-upload__tip"},"文件大小不能超过2G",-1)])]),_:1},8,["file-list"])])}}});export{J as default};
