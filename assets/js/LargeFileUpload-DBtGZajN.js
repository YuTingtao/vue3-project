import{u as L,p as y,q as p}from"./vendor-element--HxPAMq8.js";import{q as E,r as P,a0 as q,b8 as N,t as U,$ as h,S as c,A as B,af as F,v as b,b7 as f}from"./vendor-zZGLt2kn.js";const z={class:"large-file-upload"},V=E({__name:"LargeFileUpload",setup(A){const l=P([]),r=q({}),m=N(5);function g(a,e=1024*1024*10){const t=[];let n=0;for(;n<a.size;)t.push({file:a.slice(n,n+e),progressLoaded:0}),n=n+e;return t}function k(a){return new Promise(e=>{const t=new Worker("/js/hash.js"),n={fileChunks:r[a].chunks.map(o=>o.file)};t.postMessage(n),t.onmessage=o=>{const{hash:s}=o.data;s&&(e(s),t.terminate())}})}function _(a){var s;const e=l.value.findIndex(u=>u.uid===a),t=r[a].chunks.reduce((u,i)=>u+i.progressLoaded,0);if(!((s=l.value[e])!=null&&s.size))return 100;const n=l.value[e].size,o=t/n*100;return o>100?100:o}async function v(a){var t;const e=await f.post("/api/upload/merge",{fileName:l.value[0].name,hash:r[a].hash});e.status===200&&(l.value[0].url=((t=e.data)==null?void 0:t.url)||"")}async function C(a){const e=a.file.uid,t=r[e].hash,n=r[e].chunks.map((s,u)=>{const i=new FormData;return i.append("fileName",l.value[0].name),i.append("file",s.file),i.append("hash",`${t}-${u}`),m(()=>f({url:"/api/upload/uploadChunk",method:"POST",headers:{"Content-Type":"multipart/form-data"},data:i,onUploadProgress:d=>{d!=null&&d.total&&(s.progressLoaded=d.loaded);const x={...d,percent:_(e)};a.onProgress(x)}}))});await Promise.all(n).catch(s=>{a.onError(s),delete r[e],p.error("上传失败")})&&await v(e).then(s=>{a.onSuccess(s)}).catch(s=>{a.onError(s),delete r[e],p.error("上传失败")})}async function w(a){const{file:e}=a;r[e.uid]={chunks:[],hash:""},r[e.uid].chunks=g(e),r[e.uid].hash=await k(e.uid),C(a)}return(a,e)=>{const t=y,n=L;return b(),U("div",z,[h(n,{"file-list":l.value,"onUpdate:fileList":e[0]||(e[0]=o=>l.value=o),action:"#",multiple:!0,"http-request":w},{trigger:c(()=>[h(t,{type:"primary"},{default:c(()=>[...e[1]||(e[1]=[F("选择文件",-1)])]),_:1})]),tip:c(()=>[...e[2]||(e[2]=[B("div",{class:"el-upload__tip"},"文件大小不能超过2G",-1)])]),_:1},8,["file-list"])])}}});export{V as default};
