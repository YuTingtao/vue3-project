import{u as y,p as P,q as k}from"./vendor-element-BEVhuBaa.js";import{n as L,r as E,_ as q,o as N,S as _,Q as m,y as U,ae as B,q as F,b5 as v}from"./vendor-1TA-WTiO.js";async function z(g,r=5){const o=[],i=[];for(const p of g){const l=p().then(f=>(i.splice(i.indexOf(l),1),f));o.push(l),i.push(l),i.length>=r&&await Promise.race(i)}return Promise.all(o)}const M={class:"large-file-upload"},V=L({__name:"LargeFileUpload",setup(g){const r=E([]),o=q({});function i(t,e=1024*1024*10){const s=[];let n=0;for(;n<t.size;)s.push({file:t.slice(n,n+e),progressLoaded:0}),n=n+e;return s}function p(t){return new Promise(e=>{const s=new Worker("/js/hash.js"),n={fileChunks:o[t].chunks.map(u=>u.file)};s.postMessage(n),s.onmessage=u=>{const{hash:a}=u.data;a&&(e(a),s.terminate())}})}function l(t){var u;const e=r.value.findIndex(a=>a.uid===t),s=o[t].chunks.reduce((a,h)=>a+h.progressLoaded,0);if(!((u=r.value[e])!=null&&u.size))return 100;const n=r.value[e].size;return Math.floor(s/n*100)}async function f(t){var s;const e=await v.post("/api/upload/merge",{fileName:r.value[0].name,hash:o[t].hash});e.status===200&&(r.value[0].url=((s=e.data)==null?void 0:s.url)||"")}async function w(t){const e=t.file.uid,s=o[e].hash,n=o[e].chunks.map((a,h)=>{const d=new FormData;return d.append("fileName",r.value[0].name),d.append("file",a.file),d.append("hash",`${s}-${h}`),()=>v({url:"/api/upload/uploadChunk",method:"POST",headers:{"Content-Type":"multipart/form-data"},data:d,onUploadProgress:c=>{c!=null&&c.total&&(a.progressLoaded=c.loaded);const x={...c,percent:l(e)};t.onProgress(x)}})});await z(n,5).catch(a=>{t.onError(a),k.error("上传失败")})&&await f(e).then(a=>{t.onSuccess(a)}).catch(a=>{t.onError(a),k.error("上传失败")})}async function C(t){const{file:e}=t;o[e.uid]={chunks:[],hash:""},o[e.uid].chunks=i(e),o[e.uid].hash=await p(e.uid),w(t)}return(t,e)=>{const s=P,n=y;return F(),N("div",M,[_(n,{"file-list":r.value,"onUpdate:fileList":e[0]||(e[0]=u=>r.value=u),action:"#",multiple:!0,"http-request":C},{trigger:m(()=>[_(s,{type:"primary"},{default:m(()=>e[1]||(e[1]=[B("选择文件",-1)])),_:1,__:[1]})]),tip:m(()=>e[2]||(e[2]=[U("div",{class:"el-upload__tip"},"文件大小不能超过2G",-1)])),_:1},8,["file-list"])])}}});export{V as default};
