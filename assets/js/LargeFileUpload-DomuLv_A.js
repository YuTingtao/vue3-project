import{u as k,p as C,q as y}from"./vendor-element-BEVhuBaa.js";import{n as L,r as d,c as x,o as N,S as p,Q as r,X as P,Y as U,y as c,U as b,ae as z,q as B,b5 as f}from"./vendor-1TA-WTiO.js";const D={class:"large-file-upload"},V=L({__name:"LargeFileUpload",setup(S){const u=d([]),o=d([]),m=x(()=>{var a;if(!((a=o.value[0])!=null&&a.size))return 0;const e=u.value.reduce((s,t)=>s+t.progressLoaded,0);return Math.floor(e/o.value[0].size*100)});function h(e,a=1024*1024*10){const s=[];let t=0,l=0;for(;t<e.size;)s.push({file:e.slice(t,t+a),hash:e.name+l,progressLoaded:0}),t=t+a,l++;return s}function v(){return new Promise(e=>{const a=new Worker("/js/hash.js"),s={fileChunks:u.value.map(t=>t.file)};a.postMessage(s),a.onmessage=t=>{const{hash:l}=t.data;l&&(e(l),a.terminate())}})}const n=d(!1);async function _(){n.value=!0;const e=await v(),a=u.value.map((s,t)=>{const l=new FormData;return l.append("fileName",o.value[0].name),l.append("file",s.file),l.append("hash",`${e}-${t}`),f({url:"/api/upload/uploadChunk",method:"POST",data:l,onUploadProgress:i=>{i!=null&&i.total&&(s.progressLoaded=i.loaded)}})});await Promise.all(a).catch(s=>{y.error("上传失败"),n.value=!1,o.value=[]}),await g().catch(s=>{n.value=!1,o.value=[]}),n.value=!1}async function g(){var a;const e=await f.post("/api/upload/merge",{fileName:o.value[0].name,hash:u.value.map(s=>s.hash)});e.status===200&&(o.value[0].url=((a=e.data)==null?void 0:a.url)||"")}async function w(e){o.value=[{name:e.name,size:e.size}],u.value=h(e.raw),await _()}return(e,a)=>{const s=C,t=k;return B(),N("div",D,[p(t,{"file-list":o.value,"onUpdate:fileList":a[0]||(a[0]=l=>o.value=l),action:"#","auto-upload":!1,"on-change":w},{trigger:r(()=>[p(s,{type:"primary",disabled:n.value},{default:r(()=>a[1]||(a[1]=[z("选择文件",-1)])),_:1,__:[1]},8,["disabled"])]),tip:r(()=>a[2]||(a[2]=[c("div",{class:"el-upload__tip"},"文件大小不能超过2G",-1)])),default:r(()=>[P(c("span",{class:"upload-progress"},"上传中"+b(m.value)+"%...",513),[[U,n.value]])]),_:1},8,["file-list"])])}}});export{V as default};
