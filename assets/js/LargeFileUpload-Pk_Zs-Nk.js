import{u as y,p as P,q as k}from"./vendor-element-BEVhuBaa.js";import{n as L,r as E,_ as q,o as N,S as _,Q as m,y as U,ae as B,q as F,b5 as v}from"./vendor-1TA-WTiO.js";async function z(g,r=5){const n=[],i=[];for(const f of g){const c=f().then(h=>(i.splice(i.indexOf(c),1),h));n.push(c),i.push(c),i.length>=r&&await Promise.race(i)}return Promise.all(n)}const S={class:"large-file-upload"},b=L({__name:"LargeFileUpload",setup(g){const r=E([]),n=q({});function i(t,e=1024*1024*10){const s=[];let o=0;for(;o<t.size;)s.push({file:t.slice(o,o+e),progressLoaded:0}),o=o+e;return s}function f(t){return new Promise(e=>{const s=new Worker("/js/hash.js"),o={fileChunks:n[t].chunks.map(u=>u.file)};s.postMessage(o),s.onmessage=u=>{const{hash:a}=u.data;a&&(e(a),s.terminate())}})}function c(t){var a;const e=r.value.findIndex(d=>d.uid===t),s=n[t].chunks.reduce((d,l)=>d+l.progressLoaded,0);if(!((a=r.value[e])!=null&&a.size))return 100;const o=r.value[e].size,u=s/o*100;return u>100?100:u}async function h(t){var s;const e=await v.post("/api/upload/merge",{fileName:r.value[0].name,hash:n[t].hash});e.status===200&&(r.value[0].url=((s=e.data)==null?void 0:s.url)||"")}async function w(t){const e=t.file.uid,s=n[e].hash,o=n[e].chunks.map((a,d)=>{const l=new FormData;return l.append("fileName",r.value[0].name),l.append("file",a.file),l.append("hash",`${s}-${d}`),()=>v({url:"/api/upload/uploadChunk",method:"POST",headers:{"Content-Type":"multipart/form-data"},data:l,onUploadProgress:p=>{p!=null&&p.total&&(a.progressLoaded=p.loaded);const x={...p,percent:c(e)};t.onProgress(x)}})});await z(o,5).catch(a=>{t.onError(a),delete n[e],k.error("上传失败")})&&await h(e).then(a=>{t.onSuccess(a)}).catch(a=>{t.onError(a),delete n[e],k.error("上传失败")})}async function C(t){const{file:e}=t;n[e.uid]={chunks:[],hash:""},n[e.uid].chunks=i(e),n[e.uid].hash=await f(e.uid),w(t)}return(t,e)=>{const s=P,o=y;return F(),N("div",S,[_(o,{"file-list":r.value,"onUpdate:fileList":e[0]||(e[0]=u=>r.value=u),action:"#",multiple:!0,"http-request":C},{trigger:m(()=>[_(s,{type:"primary"},{default:m(()=>e[1]||(e[1]=[B("选择文件",-1)])),_:1,__:[1]})]),tip:m(()=>e[2]||(e[2]=[U("div",{class:"el-upload__tip"},"文件大小不能超过2G",-1)])),_:1},8,["file-list"])])}}});export{b as default};
